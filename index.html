import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, collection, doc, setDoc, onSnapshot, 
  updateDoc, arrayUnion, arrayRemove, addDoc 
} from 'firebase/firestore';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { 
  Settings, Plus, Home, Send, Hash, UserPlus, 
  ChevronLeft, Check, X, MessageSquare, PlusCircle, Camera 
} from 'lucide-react';

const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'cboard-v3';

export default function App() {
  const [user, setUser] = useState(null);
  const [userData, setUserData] = useState(null);
  const [activeServerId, setActiveServerId] = useState(null);
  const [activeChannelId, setActiveChannelId] = useState(null);
  const [activeDmId, setActiveDmId] = useState(null);
  const [messages, setMessages] = useState([]);
  const [allServers, setAllServers] = useState([]);
  const [inputMsg, setInputMsg] = useState('');
  const [modals, setModals] = useState({ settings: false, addFriend: false, server: false, channel: false });
  const chatEndRef = useRef(null);

  const toggleModal = (m, v) => setModals(p => ({ ...p, [m]: v }));

  useEffect(() => {
    const init = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
      else await signInAnonymously(auth);
    };
    init();
    return onAuthStateChanged(auth, setUser);
  }, []);

  useEffect(() => {
    if (!user) return;
    const profRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'profile');
    return onSnapshot(profRef, async (s) => {
      if (s.exists()) setUserData(s.data());
      else await setDoc(profRef, { uid: user.uid, username: `OP_${user.uid.slice(0, 4)}`, avatar: '', zoom: 1, pos: { x: 0, y: 0 }, servers: [], friends: [], friendRequests: [] });
    });
  }, [user]);

  useEffect(() => {
    if (!user || !userData) return;
    return onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'servers'), s => {
      setAllServers(s.docs.map(d => ({ id: d.id, ...d.data() })));
    });
  }, [user, userData]);

  useEffect(() => {
    if (!user || (!activeChannelId && !activeDmId)) return setMessages([]);
    const colId = activeChannelId ? `msg_chan_${activeChannelId}` : `msg_dm_${[user.uid, activeDmId].sort().join('_')}`;
    return onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', colId), s => {
      setMessages(s.docs.map(d => d.data()).sort((a, b) => a.timestamp - b.timestamp));
      chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
    });
  }, [user, activeChannelId, activeDmId]);

  const send = async (e) => {
    e.preventDefault();
    if (!inputMsg.trim() || !user) return;
    const colId = activeChannelId ? `msg_chan_${activeChannelId}` : `msg_dm_${[user.uid, activeDmId].sort().join('_')}`;
    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', colId), { text: inputMsg, author: userData.username, authorId: user.uid, avatar: userData.avatar, timestamp: Date.now() });
    setInputMsg('');
  };

  const currentSrv = allServers.find(s => s.id === activeServerId);

  if (!userData) return <div className="h-screen bg-black flex items-center justify-center text-orange-600 font-mono italic">SINCRONIZANDO...</div>;

  return (
    <div className="flex h-screen w-screen bg-black text-orange-600 font-mono overflow-hidden relative">
      <div className="w-16 bg-black border-r border-zinc-900 flex flex-col items-center py-4 gap-3 z-30">
        <button onClick={() => { setActiveServerId(null); setActiveChannelId(null); setActiveDmId(null); }} className={`w-12 h-12 rounded-full flex items-center justify-center ${!activeServerId ? 'bg-orange-600 text-black rounded-xl' : 'bg-zinc-900 text-zinc-500 hover:bg-orange-600/20'}`}><Home size={22} /></button>
        {allServers.filter(s => userData.servers?.includes(s.id)).map(s => (
          <button key={s.id} onClick={() => { setActiveServerId(s.id); setActiveChannelId(null); setActiveDmId(null); }} className={`w-12 h-12 rounded-full flex items-center justify-center text-xs font-bold ${activeServerId === s.id ? 'bg-orange-600 text-black rounded-xl' : 'bg-zinc-900 text-zinc-400'}`}>{s.name.slice(0, 2).toUpperCase()}</button>
        ))}
        <button onClick={() => toggleModal('server', true)} className="w-12 h-12 rounded-full bg-zinc-900/50 border border-zinc-800 flex items-center justify-center hover:text-orange-600"><Plus size={22}/></button>
      </div>

      <div className={`w-64 bg-zinc-950 border-r border-zinc-900 flex flex-col transition-transform duration-300 z-20 ${ (activeChannelId || activeDmId) ? 'max-md:-translate-x-full' : 'translate-x-0'}`}>
        <div className="h-14 border-b border-zinc-900 flex items-center px-4 font-black text-[10px] text-zinc-500 uppercase">{activeServerId ? currentSrv?.name : 'Terminal'}</div>
        <div className="flex-1 overflow-y-auto p-3">
          {!activeServerId ? (
            <>
              <button onClick={() => toggleModal('addFriend', true)} className="w-full flex items-center justify-between p-2 rounded bg-orange-600/5 border border-orange-600/20 text-[10px] font-bold mb-4 relative">
                <span>SOLICITAÇÕES</span> {userData.friendRequests?.length > 0 && <span className="w-2 h-2 bg-red-600 rounded-full animate-pulse" />}
              </button>
              {userData.friends?.map(fid => (
                <button key={fid} onClick={() => { setActiveDmId(fid); setActiveChannelId(null); }} className={`w-full flex items-center gap-3 p-2 rounded mb-1 ${activeDmId === fid ? 'bg-zinc-900 text-orange-500' : 'text-zinc-500 hover:bg-zinc-900/40'}`}>
                  <div className="w-8 h-8 rounded bg-zinc-800 flex items-center justify-center text-[8px]">DM</div>
                  <span className="text-xs truncate">OP_{fid.slice(0, 4)}</span>
                </button>
              ))}
            </>
          ) : (
            <>
              <div className="flex justify-between px-1 mb-2 text-[9px] font-bold uppercase text-zinc-700">Canais {currentSrv?.owner === user.uid && <button onClick={() => toggleModal('channel', true)} className="text-zinc-600 hover:text-orange-500"><PlusCircle size={14}/></button>}</div>
              {currentSrv?.channels?.map(c => (
                <button key={c.id} onClick={() => { setActiveChannelId(c.id); setActiveDmId(null); }} className={`w-full flex items-center gap-2 p-2 rounded mb-1 ${activeChannelId === c.id ? 'bg-zinc-900 text-orange-500' : 'text-zinc-500 hover:bg-zinc-900/40'}`}><Hash size={14}/>{c.name}</button>
              ))}
            </>
          )}
        </div>
        <div className="bg-black p-3 border-t border-zinc-900 flex items-center gap-3">
          <div className="w-9 h-9 rounded bg-zinc-900 border border-orange-600/50 overflow-hidden shrink-0">
            {userData.avatar && <img src={userData.avatar} className="max-w-none origin-top-left" style={{ transform: `scale(${userData.zoom}) translate(${userData.pos.x}px, ${userData.pos.y}px)` }} />}
          </div>
          <div className="flex-1 text-xs font-bold truncate text-orange-500">{userData.username}</div>
          <button onClick={() => toggleModal('settings', true)} className="text-zinc-700 hover:text-orange-500"><Settings size={18}/></button>
        </div>
      </div>

      <div className={`flex-1 flex flex-col bg-zinc-950 transition-all z-10 absolute inset-0 md:relative ${(activeChannelId || activeDmId) ? 'translate-x-0 opacity-100' : 'translate-x-full opacity-0 md:translate-x-0 md:opacity-100'}`}>
        <div className="h-14 border-b border-zinc-900 flex items-center px-4 justify-between bg-zinc-950/80">
          <div className="flex items-center gap-2">
            <button onClick={() => { setActiveChannelId(null); setActiveDmId(null); }} className="md:hidden"><ChevronLeft size={22}/></button>
            <span className="text-sm font-bold">{activeChannelId ? `# ${currentSrv?.channels?.find(c => c.id === activeChannelId)?.name}` : activeDmId ? 'Privado' : 'Cboard'}</span>
          </div>
          {(activeChannelId || activeDmId) && <button onClick={() => { setActiveChannelId(null); setActiveDmId(null); }}><X size={18}/></button>}
        </div>
        <div className="flex-1 overflow-y-auto p-4 space-y-4">
          {messages.map((m, i) => (
            <div key={i} className="flex gap-3">
              <div className="w-9 h-9 rounded bg-zinc-900 border border-zinc-800 shrink-0 overflow-hidden">{m.avatar && <img src={m.avatar} className="w-full h-full object-cover"/>}</div>
              <div className="flex-1"><div className="flex items-baseline gap-2"><span className="text-xs font-bold text-orange-600">{m.author}</span><span className="text-[8px] text-zinc-700">{new Date(m.timestamp).toLocaleTimeString()}</span></div><div className="text-xs text-zinc-400 font-sans">{m.text}</div></div>
            </div>
          ))}
          <div ref={chatEndRef} />
        </div>
        {(activeChannelId || activeDmId) && (
          <form onSubmit={send} className="p-4 border-t border-zinc-900/30"><div className="relative"><input value={inputMsg} onChange={e => setInputMsg(e.target.value)} placeholder="Transmitir..." className="w-full bg-zinc-900/30 border border-zinc-800 rounded-lg p-3 text-xs outline-none focus:border-orange-600/40"/><button type="submit" className="absolute right-3 top-2.5 text-zinc-700 hover:text-orange-500"><Send size={18}/></button></div></form>
        )}
      </div>

      {modals.addFriend && (
        <div className="fixed inset-0 bg-black/90 flex items-center justify-center z-[100] p-4">
          <div className="bg-zinc-950 border border-orange-600/30 p-6 w-full max-w-sm rounded-xl">
            <div className="flex justify-between mb-4"><h3 className="font-bold">AMIZADES</h3><button onClick={() => toggleModal('addFriend', false)}><X size={18}/></button></div>
            <div className="flex gap-2 mb-4"><input id="f-id" className="flex-1 bg-black border border-zinc-800 p-2 text-[10px] rounded" placeholder="UID do Destino"/><button onClick={() => { const id = document.getElementById('f-id').value; if(id) updateDoc(doc(db, 'artifacts', appId, 'users', id, 'settings', 'profile'), { friendRequests: arrayUnion(user.uid) }) }} className="bg-orange-600 text-black px-3 font-bold text-[10px] rounded">PEDIR</button></div>
            <div className="space-y-2 overflow-y-auto max-h-40">
              {userData.friendRequests?.map(id => (
                <div key={id} className="flex justify-between p-2 bg-zinc-900 rounded items-center"><span className="text-[9px]">OP_{id.slice(0,8)}</span><div className="flex gap-1">
                  <button onClick={() => { updateDoc(doc(db,'artifacts',appId,'users',user.uid,'settings','profile'),{friends:arrayUnion(id),friendRequests:arrayRemove(id)}); updateDoc(doc(db,'artifacts',appId,'users',id,'settings','profile'),{friends:arrayUnion(user.uid)}) }} className="p-1 bg-orange-600 rounded text-black"><Check size={12}/></button>
                  <button onClick={() => updateDoc(doc(db,'artifacts',appId,'users',user.uid,'settings','profile'),{friendRequests:arrayRemove(id)})} className="p-1 bg-zinc-800 rounded"><X size={12}/></button>
                </div></div>
              ))}
            </div>
          </div>
        </div>
      )}

      {modals.settings && (
        <div className="fixed inset-0 bg-black/95 flex items-center justify-center z-[100] p-4">
          <div className="bg-zinc-950 border border-orange-600 p-8 w-full max-w-sm rounded-3xl relative">
            <button onClick={() => toggleModal('settings', false)} className="absolute top-4 right-4"><X size={20}/></button>
            <div className="flex flex-col items-center gap-4">
              <div className="w-24 h-24 rounded-full border border-orange-600 overflow-hidden bg-black flex items-center justify-center">
                {userData.avatar ? <img src={userData.avatar} className="max-w-none origin-top-left" style={{transform: `scale(${userData.zoom}) translate(${userData.pos.x}px, ${userData.pos.y}px)`}} /> : <Camera className="opacity-20"/>}
              </div>
              <button onClick={() => { const i = document.createElement('input'); i.type='file'; i.onchange=e=>{const r=new FileReader();r.onload=v=>updateDoc(doc(db,'artifacts',appId,'users',user.uid,'settings','profile'),{avatar:v.target.result,zoom:1,pos:{x:0,y:0}});r.readAsDataURL(e.target.files[0])}; i.click(); }} className="text-[9px] font-bold text-orange-500 uppercase underline">Alterar Foto</button>
              <div className="w-full text-[9px] space-y-2">
                <div>ZOOM: <input type="range" min="0.5" max="3" step="0.1" value={userData.zoom} onChange={e=>updateDoc(doc(db,'artifacts',appId,'users',user.uid,'settings','profile'),{zoom:parseFloat(e.target.value)})} className="w-full accent-orange-600"/></div>
                <div className="flex gap-2">X: <input type="number" value={userData.pos.x} onChange={e=>updateDoc(doc(db,'artifacts',appId,'users',user.uid,'settings','profile'),{pos:{...userData.pos,x:parseInt(e.target.value)}})} className="w-full bg-black border border-zinc-900 p-1 rounded"/> Y: <input type="number" value={userData.pos.y} onChange={e=>updateDoc(doc(db,'artifacts',appId,'users',user.uid,'settings','profile'),{pos:{...userData.pos,y:parseInt(e.target.value)}})} className="w-full bg-black border border-zinc-900 p-1 rounded"/></div>
                <div>NOME: <input value={userData.username} onChange={e=>updateDoc(doc(db,'artifacts',appId,'users',user.uid,'settings','profile'),{username:e.target.value})} className="w-full bg-black border border-zinc-900 p-2 rounded outline-none"/></div>
              </div>
              <div className="text-[7px] text-zinc-800 break-all select-all">UID: {user.uid}</div>
            </div>
          </div>
        </div>
      )}

      {modals.server && (
        <div className="fixed inset-0 bg-black/90 flex items-center justify-center z-[110] p-4 text-center">
          <div className="bg-zinc-950 border border-orange-600 p-6 w-full max-w-xs rounded-xl">
             <h3 className="text-xs font-black mb-4 uppercase">Nova Estação</h3>
             <input id="s-n" className="w-full bg-black border border-zinc-900 p-3 rounded mb-4 text-xs text-center outline-none" placeholder="NOME" />
             <div className="flex gap-2"><button onClick={() => toggleModal('server', false)} className="flex-1 text-[10px]">VOLTAR</button><button onClick={async () => { const n = document.getElementById('s-n').value; if(!n) return; const r = await addDoc(collection(db,'artifacts',appId,'public','data','servers'),{name:n,owner:user.uid,channels:[{id:crypto.randomUUID(),name:'geral'}]}); await updateDoc(doc(db,'artifacts',appId,'users',user.uid,'settings','profile'),{servers:arrayUnion(r.id)}); toggleModal('server', false); }} className="flex-1 py-2 bg-orange-600 text-black font-black text-[10px] rounded">CRIAR</button></div>
          </div>
        </div>
      )}

      {modals.channel && (
        <div className="fixed inset-0 bg-black/90 flex items-center justify-center z-[110] p-4">
          <div className="bg-zinc-950 border border-orange-600 p-6 w-full max-w-xs rounded-xl">
             <h3 className="text-xs font-black mb-4 uppercase">Novo Canal</h3>
             <input id="c-n" className="w-full bg-black border border-zinc-900 p-3 rounded mb-4 text-xs outline-none" placeholder="nome-do-canal" />
             <div className="flex gap-2"><button onClick={() => toggleModal('channel', false)} className="flex-1 text-[10px]">CANCELAR</button><button onClick={() => { const n = document.getElementById('c-n').value; if(n) updateDoc(doc(db,'artifacts',appId,'public','data','servers',activeServerId),{channels:arrayUnion({id:crypto.randomUUID(),name:n.toLowerCase().replace(/\s/g,'-')})}); toggleModal('channel', false); }} className="flex-1 py-2 bg-orange-600 text-black font-black text-[10px] rounded">ADICIONAR</button></div>
          </div>
        </div>
      )}
    </div>
  );
}
