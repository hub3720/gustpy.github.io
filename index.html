<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>AN-74 Flight Simulator</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #87CEEB; font-family: sans-serif; }
        
        /* UI TOTALMENTE BRANCA */
        #ui { 
            position: absolute; top: 20px; left: 20px; 
            color: #FFFFFF; pointer-events: none; 
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }
        .info { font-size: 20px; font-weight: bold; margin-bottom: 5px; }

        .controls { position: absolute; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; pointer-events: all; }
        
        button { 
            padding: 12px 20px; cursor: pointer; background: rgba(255,255,255,0.2); 
            color: #FFFFFF; border: 2px solid #FFFFFF; font-weight: bold; 
            backdrop-filter: blur(4px);
        }
        button:active { background: #FFFFFF; color: #000; }
        
        #joystick-wrapper {
            position: absolute; bottom: 30px; left: 30px; width: 140px; height: 140px;
            background: rgba(255,255,255,0.1); border-radius: 50%; border: 2px solid #FFFFFF;
            pointer-events: all; touch-action: none;
        }
        #joystick-stick {
            position: absolute; width: 50px; height: 50px; background: #FFFFFF;
            border-radius: 50%; top: 45px; left: 45px;
        }
        
        .thr-box {
            position: absolute; bottom: 30px; left: 200px; display: flex; flex-direction: column; align-items: center; color: #FFFFFF;
        }
        input[type=range] { -webkit-appearance: slider-vertical; width: 30px; height: 140px; }
    </style>
</head>
<body>

    <div id="ui">
        <div class="info" id="ui-spd">SPEED: 0 kts</div>
        <div class="info" id="ui-alt">ALTITUDE: 0 m</div>
        <div class="info" id="ui-sts">STATUS: ON RUNWAY</div>
    </div>

    <div class="controls">
        <button id="btn-engine">TURN ON</button>
        <button id="btn-rev">REVERSE: OFF</button>
    </div>

    <div class="thr-box">
        <b>THR</b>
        <input type="range" id="input-thr" min="0" max="1" step="0.01" value="0">
    </div>

    <div id="joystick-wrapper">
        <div id="joystick-stick"></div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/examples/jsm/loaders/GLTFLoader": "https://unpkg.com/three@0.160.0/examples/jsm/loaders/GLTFLoader.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader';

        // CENA E CÉU
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);
        scene.fog = new THREE.Fog(0x87CEEB, 1, 100000); // Neblina azul para o horizonte

        const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 2000000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // LUZES (Para o verde aparecer)
        const light1 = new THREE.AmbientLight(0xffffff, 1);
        scene.add(light1);
        const light2 = new THREE.DirectionalLight(0xffffff, 1.5);
        light2.position.set(100, 1000, 100);
        scene.add(light2);

        // VARIÁVEIS
        let plane = new THREE.Group();
        let speed = 0;
        let isEngine = false;
        let isRev = false;
        let thr = 0;
        let joy = { x: 0, y: 0 };
        const radius = 637000;

        // PLANETA VERDE
        const pGeo = new THREE.SphereGeometry(radius, 128, 128);
        const pMat = new THREE.MeshLambertMaterial({ color: 0x228B22 });
        const planet = new THREE.Mesh(pGeo, pMat);
        planet.position.y = -radius;
        scene.add(planet);

        // PISTA
        const runway = new THREE.Mesh(
            new THREE.PlaneGeometry(100, 750),
            new THREE.MeshLambertMaterial({ color: 0x444444 })
        );
        runway.rotation.x = -Math.PI / 2;
        runway.position.y = 0.1;
        scene.add(runway);

        // ATMOSFERA
        const colors = [0xadd8e6, 0x4682b4, 0x000080];
        const heights = [3500, 15000, 30000];
        heights.forEach((h, i) => {
            const layer = new THREE.Mesh(
                new THREE.SphereGeometry(radius + h, 64, 64),
                new THREE.MeshBasicMaterial({ color: colors[i], transparent: true, opacity: 0.1, side: THREE.BackSide })
            );
            layer.position.y = -radius;
            scene.add(layer);
        });

        // LOADER DO AN74.GLB (CARREGA DIRETO NA RAIZ)
        const loader = new GLTFLoader();
        loader.load('an74.glb', (gltf) => {
            plane.add(gltf.scene);
        }, undefined, (err) => {
            // Backup se o arquivo não estiver lá
            const mock = new THREE.Mesh(new THREE.BoxGeometry(2,1,6), new THREE.MeshLambertMaterial({color: 0xeeeeee}));
            plane.add(mock);
        });
        scene.add(plane);
        plane.position.set(0, 0.5, 300);

        // JOYSTICK
        const stick = document.getElementById('joystick-stick');
        const wrap = document.getElementById('joystick-wrapper');
        wrap.onpointermove = (e) => {
            if (e.buttons === 1) {
                const r = wrap.getBoundingClientRect();
                joy.x = (e.clientX - r.left - 70) / 70;
                joy.y = -(e.clientY - r.top - 70) / 70;
                joy.x = Math.max(-1, Math.min(1, joy.x));
                joy.y = Math.max(-1, Math.min(1, joy.y));
                stick.style.transform = `translate(${joy.x * 40}px, ${-joy.y * 40}px)`;
            }
        };
        wrap.onpointerup = () => {
            joy = { x: 0, y: 0 };
            stick.style.transform = `translate(0,0)`;
        };

        // UI
        document.getElementById('btn-engine').onclick = (e) => {
            isEngine = !isEngine;
            e.target.innerText = isEngine ? "TURN OFF" : "TURN ON";
        };
        document.getElementById('btn-rev').onclick = (e) => {
            isRev = !isRev;
            e.target.innerText = isRev ? "REVERSE: ON" : "REVERSE: OFF";
        };
        document.getElementById('input-thr').oninput = (e) => thr = parseFloat(e.target.value);

        const clock = new THREE.Clock();
        function loop() {
            const dt = clock.getDelta();
            const alt = plane.position.y;

            // ACELERAÇÃO
            let power = isEngine ? thr * 200 : 0;
            if (isRev && alt < 1) power = -thr * 80;
            speed += (power - (speed * 0.1)) * dt;
            if (speed > 366) speed = 366;
            if (speed < 0) speed = 0;

            if (alt <= 0.6) {
                // CHÃO: SÓ VIRA O NARIZ (YAW)
                plane.position.y = 0.5;
                plane.rotation.x = 0;
                plane.rotation.z = 0;
                plane.rotation.y -= joy.x * dt * 2;
                // DECOLAGEM 150KTS + PUXAR MANCHE
                if (speed > 150 && joy.y > 0.2) plane.position.y += 2 * dt * (speed/100);
            } else {
                // AR: ROLL, PITCH E CURVA
                const tRoll = -joy.x * 0.52; 
                const tPitch = joy.y * 0.6;
                plane.rotation.z = THREE.MathUtils.lerp(plane.rotation.z, tRoll, 0.05);
                plane.rotation.x = THREE.MathUtils.lerp(plane.rotation.x, tPitch, 0.04);
                plane.rotation.y -= plane.rotation.z * dt * 1.5;

                // SUSTENTAÇÃO E STALL
                const lift = (speed / 150) * (1 + plane.rotation.x);
                plane.position.y += (lift - 1.0) * 45 * dt;
                if (speed < 140) {
                    plane.rotation.x += 0.2 * dt;
                    plane.position.y -= 30 * dt;
                }
            }

            plane.translateZ(speed * dt * 0.8);

            // CÂMERA
            const cPos = new THREE.Vector3(0, 10, -30).applyMatrix4(plane.matrixWorld);
            camera.position.lerp(cPos, 0.1);
            camera.lookAt(plane.position);

            // TELEMETRIA
            document.getElementById('ui-spd').innerText = `SPEED: ${Math.round(speed)} kts`;
            document.getElementById('ui-alt').innerText = `ALTITUDE: ${Math.round(alt)} m`;
            document.getElementById('ui-sts').innerText = `STATUS: ${alt > 1 ? (speed < 145 ? 'STALL' : 'FLYING') : 'TAXIING'}`;

            renderer.render(scene, camera);
            requestAnimationFrame(loop);
        }

        loop();

        window.onresize = () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        };
    </script>
</body>
</html>
