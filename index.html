<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Falcon 9 Mobile Simulator</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; touch-action: none; }
        #ui { position: absolute; top: 10px; left: 10px; color: white; pointer-events: none; text-shadow: 1px 1px 2px black; }
        .data { font-size: 12px; margin-bottom: 2px; }
        
        /* Botões de Controle */
        #controls { position: absolute; bottom: 20px; width: 100%; display: flex; justify-content: space-around; pointer-events: none; }
        .btn { 
            width: 80px; height: 80px; background: rgba(255,255,255,0.2); 
            border: 2px solid white; border-radius: 50%; color: white; 
            display: flex; align-items: center; justify-content: center; 
            font-weight: bold; pointer-events: auto; user-select: none;
            -webkit-user-select: none;
        }
        #btn-engine { background: rgba(255, 100, 0, 0.4); }
        #btn-sep { 
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            width: 150px; height: 40px; border-radius: 5px; background: #d9534f;
            display: none; /* Aparece após 1000m */
        }
        
        #fuel-container { width: 120px; height: 10px; background: #333; border: 1px solid #fff; margin-top: 5px; }
        #fuel-bar { width: 100%; height: 100%; background: #0f0; }
    </style>
</head>
<body>

    <div id="ui">
        <div class="data">ALTITUDE: <span id="alt">0</span> m</div>
        <div class="data">VELOCIDADE: <span id="vel">0</span> km/h</div>
        <div class="data">ESTÁGIO: <span id="stg">1</span></div>
        <div id="fuel-container"><div id="fuel-bar"></div></div>
    </div>

    <button id="btn-sep" class="btn">SEPARAR ESTÁGIOS</button>

    <div id="controls">
        <div id="btn-engine" class="btn">MOTOR</div>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- CENA E RENDER (OTIMIZADO) ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);
        
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 20000);
        const renderer = new THREE.WebGLRenderer({ antialias: false }); // Desativado para performance no E22
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.body.appendChild(renderer.domElement);

        // --- LUZES ---
        const light = new THREE.DirectionalLight(0xffffff, 1.5);
        light.position.set(5, 10, 7);
        scene.add(light);
        scene.add(new THREE.AmbientLight(0xffffff, 0.5));

        // --- TERRA ---
        const ground = new THREE.Mesh(
            new THREE.PlaneGeometry(10000, 10000),
            new THREE.MeshStandardMaterial({ color: 0x222222 })
        );
        ground.rotation.x = -Math.PI / 2;
        scene.add(ground);

        // --- FOGUETE (FALCON 9) ---
        const rocket = new THREE.Group();
        
        // Estágio 1
        const s1 = new THREE.Mesh(new THREE.CylinderGeometry(1, 1, 15, 16), new THREE.MeshStandardMaterial({color: 0xffffff}));
        s1.position.y = 7.5;
        rocket.add(s1);

        // Estágio 2
        const s2 = new THREE.Group();
        const s2Body = new THREE.Mesh(new THREE.CylinderGeometry(1, 1, 5, 16), new THREE.MeshStandardMaterial({color: 0xffffff}));
        const nose = new THREE.Mesh(new THREE.ConeGeometry(1, 3, 16), new THREE.MeshStandardMaterial({color: 0xffffff}));
        s2Body.position.y = 2.5;
        nose.position.y = 6.5;
        s2.add(s2Body);
        s2.add(nose);
        s2.position.y = 15;
        rocket.add(s2);

        // Fogo (Partículas simples para performance)
        const fireGeo = new THREE.ConeGeometry(0.8, 5, 8);
        fireGeo.translate(0, -2.5, 0);
        const fireMat = new THREE.MeshBasicMaterial({ color: 0xffa500, transparent: true, opacity: 0.8 });
        const fire = new THREE.Mesh(fireGeo, fireMat);
        fire.visible = false;
        rocket.add(fire);

        scene.add(rocket);

        // --- ESTADO ---
        let state = {
            alt: 0, vel: 0, fuel: 100, 
            engineOn: false, stage: 1, 
            separated: false, s2vel: 0
        };

        // --- CONTROLES ---
        const btnEngine = document.getElementById('btn-engine');
        const btnSep = document.getElementById('btn-sep');

        const startEngine = () => state.engineOn = true;
        const stopEngine = () => state.engineOn = false;

        btnEngine.addEventListener('mousedown', startEngine);
        btnEngine.addEventListener('mouseup', stopEngine);
        btnEngine.addEventListener('touchstart', (e) => { e.preventDefault(); startEngine(); });
        btnEngine.addEventListener('touchend', stopEngine);
        
        window.addEventListener('keydown', (e) => { if(e.code === 'Space') startEngine(); });
        window.addEventListener('keyup', (e) => { if(e.code === 'Space') stopEngine(); });

        btnSep.addEventListener('click', () => {
            if(state.stage === 1) {
                state.stage = 2;
                state.s2vel = state.vel;
                btnSep.style.display = 'none';
                document.getElementById('stg').innerText = "2";
            }
        });

        // --- LOOP ---
        function animate() {
            requestAnimationFrame(animate);

            if (state.engineOn && state.fuel > 0) {
                state.vel += 0.2;
                state.fuel -= 0.05; // Dura aprox. 5-6 minutos
                fire.visible = true;
                fire.scale.set(1, 0.8 + Math.random() * 0.4, 1);
            } else {
                state.vel -= 0.05; // Gravidade
                fire.visible = false;
            }

            if (state.stage === 1) {
                state.alt += state.vel * 0.1;
                rocket.position.y = state.alt;
            } else {
                // Separação
                state.alt += state.vel * 0.1;
                s2.position.y += 0.2; // Afasta do S1 visualmente
                rocket.position.y = state.alt;
                // O S1 começa a cair (efeito visual)
                s1.position.y -= 0.5;
            }

            if(state.alt < 0) { state.alt = 0; state.vel = 0; }

            // Atmosfera -> Espaço
            const skyVal = Math.max(0, 135 - state.alt / 20);
            scene.background.set(`rgb(${Math.floor(skyVal)}, ${Math.floor(skyVal*1.5)}, ${Math.floor(skyVal*1.9)})`);

            // UI
            document.getElementById('alt').innerText = Math.floor(state.alt);
            document.getElementById('vel').innerText = Math.floor(state.vel * 10);
            document.getElementById('fuel-bar').style.width = state.fuel + "%";
            if(state.alt > 500 && state.stage === 1) btnSep.style.display = 'flex';

            // Câmera segue o foguete
            camera.position.set(rocket.position.x, rocket.position.y + 10, rocket.position.z + 40);
            camera.lookAt(rocket.position);

            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();
    </script>
</body>
</html>
